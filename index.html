<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BeerMarket Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --pad: 14px;
      --topSafe: env(safe-area-inset-top, 0px);
      --bottomSafe: env(safe-area-inset-bottom, 0px);
      --tgTop: 0px;
      --tgBottom: 0px;

      --bg: #0b0b0c;
      --card: #151518;
      --text: #f2f2f2;
      --muted: rgba(242,242,242,.7);
      --line: rgba(255,255,255,.08);
      --btn: #2a7cff;
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow: hidden;
    }

    .app{
      height: 100%;
      display: flex;
      flex-direction: column;
      padding-top: calc(var(--pad) + var(--topSafe) + var(--tgTop));
      padding-bottom: calc(var(--pad) + var(--bottomSafe) + var(--tgBottom));
    }

    .content{
      flex: 1;
      overflow: auto;
      padding: 0 var(--pad);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .title{
      font-size: 16px;
      font-weight: 800;
      margin: 0 0 6px 0;
    }
    .muted{ color: var(--muted); font-size: 13px; }

    .tiles{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button{
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 0;
      background: var(--btn);
      color: white;
      font-size: 15px;
      font-weight: 700;
    }
    button.secondary{
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 700;
    }

    input, textarea{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    textarea{ resize: vertical; min-height: 110px; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .bottomBar{
      padding: 10px var(--pad) 0 var(--pad);
      border-top: 1px solid var(--line);
      background: linear-gradient(to bottom, rgba(11,11,12,0), rgba(11,11,12,1));
    }

    .hidden{ display:none; }
    .small{ font-size:12px; opacity:.85; }
  </style>
</head>
<body>
<div class="app">
  <div class="content">

    <div class="card">
      <div class="title">BeerMarket</div>
      <div id="user" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      <div id="env" class="muted small"></div>
    </div>

    <div class="card">
      <div class="muted">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
      <div class="tiles" id="tiles"></div>
    </div>

    <div class="card">
      <div class="muted">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–¢–ù</div>
      <div style="margin-top:10px; display:grid; gap:10px;">
        <input id="ttn" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¢–¢–ù (—Ü–∏—Ñ—Ä—ã)" inputmode="numeric" />
        <button id="btnTtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
      </div>
      <div class="muted small" style="margin-top:8px;">
        –°–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞: mini app –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å, –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —á–∞—Ç–µ.
      </div>
    </div>

    <div class="card">
      <div class="row2">
        <button id="btnDebug" class="secondary">Debug</button>
        <button id="btnStart" class="secondary">–°—Ç–∞—Ä—Ç</button>
      </div>

      <div id="debugBox" class="hidden" style="margin-top:10px; display:grid; gap:10px;">
        <div class="muted">–¢–µ—Å—Ç–æ–≤—ã–π JSON ‚Üí bot</div>
        <textarea id="payload" placeholder='{"action":"ping"}'></textarea>
        <button id="btnSendJson" class="secondary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å JSON</button>
      </div>
    </div>

  </div>

  <div class="bottomBar">
    <div class="row2">
      <button id="btnRefresh" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <button id="btnClose" class="secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp;

  function setSafeInsets() {
    const top = tg?.safeAreaInset?.top ?? tg?.contentSafeAreaInset?.top ?? 0;
    const bottom = tg?.safeAreaInset?.bottom ?? tg?.contentSafeAreaInset?.bottom ?? 0;
    document.documentElement.style.setProperty('--tgTop', top + 'px');
    document.documentElement.style.setProperty('--tgBottom', bottom + 'px');
  }

  function applyTgTheme() {
    const p = tg?.themeParams || {};
    const css = document.documentElement.style;
    if (p.bg_color) css.setProperty('--bg', p.bg_color);
    if (p.secondary_bg_color) css.setProperty('--card', p.secondary_bg_color);
    if (p.text_color) css.setProperty('--text', p.text_color);
    if (p.hint_color) css.setProperty('--muted', p.hint_color);
    if (p.button_color) css.setProperty('--btn', p.button_color);
  }

  function popupOk(title, msg) {
    if (!tg?.showPopup) return;
    tg.showPopup({
      title: title || "BeerMarket",
      message: msg || "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
      buttons: [{type:"ok"}]
    });
  }

  function sendAction(action, extra = {}) {
    const payload = { action, ts: Date.now(), ...extra };
    const raw = JSON.stringify(payload);
    try {
      tg?.sendData?.(raw);
      tg?.HapticFeedback?.impactOccurred?.("light");
      popupOk("BeerMarket", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç");
    } catch (e) {
      alert("sendData error: " + (e?.message || e));
    }
  }

  const ACTIONS = [
    { text: "üìë –ü—Ä–∞–π—Å—ã", action: "prices.open" },
    { text: "üéÅ –ê–∫—Ü–∏–∏", action: "promo.open" },
    { text: "üöö –ì—Ä–∞—Ñ–∏–∫", action: "schedule.show" },
    { text: "üîé –ü–æ–∏—Å–∫", action: "search.open" },
    { text: "üîÑ –û–±–Ω–æ–≤–∏—Ç—å", action: "refresh.open" },
    { text: "üè† –ú–µ–Ω—é", action: "menu.start" },
  ];

  function renderTiles() {
    const box = document.getElementById("tiles");
    box.innerHTML = "";
    for (const a of ACTIONS) {
      const b = document.createElement("button");
      b.textContent = a.text;
      b.onclick = () => sendAction(a.action);
      box.appendChild(b);
    }
  }

  if (tg) {
    tg.ready();
    tg.expand();
    setSafeInsets();
    applyTgTheme();

    tg.onEvent?.("safeAreaChanged", setSafeInsets);
    tg.onEvent?.("contentSafeAreaChanged", setSafeInsets);
    tg.onEvent?.("themeChanged", applyTgTheme);

    const u = tg.initDataUnsafe?.user;
    document.getElementById("user").textContent = u
      ? `@${u.username ?? "–±–µ–∑_—é–∑–µ—Ä–Ω–µ–π–º–∞"} ‚Ä¢ id ${u.id}`
      : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω";

    const ver = new URLSearchParams(location.search).get("v");
    document.getElementById("env").textContent =
      `platform: ${tg.platform || "-"} ‚Ä¢ ver: ${tg.version || "-"}${ver ? " ‚Ä¢ v=" + ver : ""}`;
  } else {
    document.getElementById("user").textContent = "–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram WebApp";
  }

  renderTiles();

  document.getElementById("btnClose").onclick = () => tg?.close?.();
  document.getElementById("btnRefresh").onclick = () => location.reload();

  document.getElementById("btnStart").onclick = () => sendAction("menu.start");

  document.getElementById("btnTtn").onclick = () => {
    const ttn = (document.getElementById("ttn").value || "").trim();
    if (!ttn) return popupOk("–¢–¢–ù", "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¢–¢–ù");
    // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å; –±–æ—Ç —Ä–µ—à–∏—Ç, –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
    sendAction("ttn.check", { ttn });
  };

  document.getElementById("btnDebug").onclick = () => {
    const box = document.getElementById("debugBox");
    box.classList.toggle("hidden");
  };

  document.getElementById("btnSendJson").onclick = () => {
    const raw = document.getElementById("payload").value.trim();
    if (!raw) return;
    try {
      tg?.sendData?.(raw);
      popupOk("Debug", "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    } catch (e) {
      alert("sendData error: " + (e?.message || e));
    }
  };
</script>
</body>
</html>
